name: Build and Release

on:
   release:
      types: [created]

jobs:
   build-linux:
      runs-on: ubuntu-latest
      # Required in 2026 to allow uploading assets to a release
      permissions:
         contents: write

      steps:
         - name: Checkout Code
           uses: actions/checkout@v4

         - name: Install Native Build Tools
           run: |
              sudo apt-get update
              sudo apt-get install -y rpm fakeroot

         - name: Setup Node.js
           uses: actions/setup-node@v4
           with:
              node-version: "24" # Active LTS in 2026
              cache: "npm"

         - name: Install Dependencies
           run: npm install

         - name: Build and Package
           # This generates the .deb and .rpm files in out/make/
           run: npm run make -- --platform=linux --arch=x64

         - name: Debug Verify Files
           run: find out/make -type f \( -name "*.deb" -o -name "*.rpm" \)

         - name: Upload to Release
           uses: softprops/action-gh-release@v2
           if: startsWith(github.ref, 'refs/tags/')
           with:
              # Recursive glob to find files in subfolders
              files: |
                 out/make/**/*.deb
                 out/make/**/*.rpm
              fail_on_unmatched_files: true
           env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
